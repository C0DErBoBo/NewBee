# 产品需求文档

## 0. 文档说明
- 本文为赛事运营平台的唯一业务需求来源，涵盖原《需求文档.md》与《需求文件2.md》内容，所有功能迭代需以此为准并同步更新。
- 文档使用 UTF-8 编码，保持与《AGENTS 协作指南》一致；新增或调整需求需先与 PM/RD 对齐并更新本文件及 `TODO.md`。
- 目标读者：产品、前后端开发、测试、运维及运营团队。

## 1. 产品愿景与目标
- 打造基于 **React + TypeScript** 的赛事管理 SPA，为办赛方提供一站式赛事配置、报名管理与数据导出能力，同时兼顾参赛队伍与简化版管理员。
- 当前聚焦两大核心能力：用户注册/登录（含报名）与赛事创建配置（项目、组别、流程、计分、判罚）。
- 成功指标：注册完成率 ≥ 90%，赛事创建成功率 ≥ 95%，满足《AGENTS.md》中的业务 KPI。

## 2. 用户角色与旅程
- **办赛方（organizer）**：注册登录 → 创建赛事 → 配置项目/组别/规则 → 管理报名与成绩 → 导出资料。
- **参赛队伍（team 角色）**：登录 → 维护队伍花名册/报名 → 跟进审核与赛程 → 录入成绩（视权限）。
- **管理员（admin）**：登录 → 审核账号 → 批量导入/创建队伍 → 调整角色 → 导出账号/赛事数据 → 运维判罚与成绩。
- 未来扩展（可选）：裁判/志愿者、观赛端等，在规划前需补充需求与权限模型。

## 3. 核心业务流程概览
1. **用户认证**：验证码/微信登录 → JWT 签发 → axios 拦截器自动刷新。
2. **赛事创建**：向导式流程（基本信息 → 项目 → 组别 → 规则 → 确认） → 后端事务写入赛事、项目、组别、规则。
3. **报名与队伍同步**：队伍维护花名册 → 触发报名写入 → 办赛方/管理员审批 → 状态统计。
4. **判罚与成绩处理**：判罚规则维护 → 成绩录入 → 判罚/扣分 → 晋级与积分更新。
5. **账号运维**：管理员批量导入/创建队伍 → 生成账号与随机密码 → 导出账号台账 → 权限调整。

## 4. 赛事创建与管理

### 4.1 赛事列表
- 展示字段：赛事名称、报名时间、比赛时间、地点、报名人数、队伍数、创建人、操作（详情、编辑、向导）。
- 支持刷新按钮，预留分页与筛选（按状态、创建人、标签等）。

### 4.2 创建/编辑向导
- 步骤：基本信息 → 项目配置 → 组别配置 → 规则与报名设置 → 确认提交。
- 校验：赛事名称、报名起止时间必填且 `signupStartAt < signupEndAt`；比赛开始时间需早于结束时间。
- 默认模板：调用 `GET /competitions/templates/events` 载入标准田径项目，自动填充项目类型、赛道模式、计分类型、默认赛次与判罚集；默认组别包含“男子学生组”“女子学生组”；默认规则含积分表 9/7/6/5/4/3/2/1、晋级示例及异常项。
- 提交：成功展示 Toast 并刷新列表，失败时保留表单与错误信息；支持保存草稿（TODO）。

### 4.3 项目类型、赛次与计分
- **项目类型**：支持【田径标准类】【全能类】【趣味类】【评分类】；模板项目默认归于田径标准类。
- **竞赛模式**：竞赛类项目可选择 `分道跑 (lane)` 或 `不分道跑 (mass)`，影响赛道编排与成绩录入视图。
- **计分类型**：`计时类 (timing)`、`远度类 (distance)`、`高度类 (height)`；决定成绩单位、精度与默认排序方式。
- **赛次设置**：
  - 每个项目至少包含一个赛次，字段：赛次编号、日期、开始时间、预计结束时间、场地/赛道范围、备注。
  - 支持批量生成与复制赛次、排序调整、启用/停用；报名时需同步校验赛次容量。
- **计分规则**：
  - 项目级可覆盖默认积分表、晋级逻辑（最好成绩 / 累计成绩 / 全能换算）。
  - 全能类需支持子项权重或国际通用换算表（后续引入）。
  - 规则配置以结构化表单录入，并保留 JSON 备份以应对高级场景。
- **赛道配置**：
  - 分道跑项目需维护道次数量、锁定规则、导出功能。
  - 不分道跑项目需支持分组与滚动起跑提示。
- **互锁逻辑**：修改项目或赛次后需检查报名、成绩、判罚引用的配置，提示潜在冲突。

### 4.4 组别与报名限制
- 组别字段：名称、性别（男/女/混合）、年龄段、身份类型（如学生/教师）、人数上限、团队人数、扩展配置。
- 报名限制：每人可报项目数、是否允许跨队伍、人脸/实名要求、附件必填项；存储于 `competitions.config.registration`。

### 4.5 判罚规则与成绩处理
- 独立“判罚规则”页面，可批量维护判罚编号 + 判罚内容（扣分、取消成绩、备注要求），支持导入/导出与启用/停用。
- 项目需绑定判罚规则集；成绩处理页根据绑定规则展示可选判罚项。
- 判罚操作需记录操作人、时间、判罚编号，支持撤销与日志导出，确保仲裁可追溯。

### 4.6 接口契约
- `GET /competitions/templates/events`：返回标准项目模板（含 category、competitionMode、scoringType、unitType、默认赛次与判罚）。
- `GET /competitions`：返回赛事列表及统计（报名人数、队伍数）。
- `POST /competitions` / `PATCH /competitions/:id`：
  ```json
  {
    "name": "...",
    "location": "...",
    "signupStartAt": "2025-11-01T08:00:00Z",
    "signupEndAt": "2025-11-10T23:59:59Z",
    "startAt": "...",
    "endAt": "...",
    "config": { "registration": { "maxEventsPerParticipant": 2 } },
    "events": [
      {
        "name": "100m",
        "category": "track",
        "competitionMode": "lane",
        "scoringType": "timing",
        "unitType": "individual",
        "sessions": [
          {
            "sessionCode": "Prelim-A",
            "date": "2025-11-20",
            "startTime": "09:00",
            "endTime": "10:00",
            "venue": "主场地"
          }
        ],
        "isCustom": false,
        "config": {}
      }
    ],
    "groups": [
      {
        "name": "男子学生组",
        "gender": "male",
        "ageBracket": "18-25",
        "identityType": "学生",
        "maxParticipants": 100,
        "teamSize": null,
        "config": {}
      }
    ],
    "rules": {
      "scoring": { "defaultTable": [9,7,6,5,4,3,2,1] },
      "flow": { "stages": ["预赛","决赛"] },
      "penalties": { "disqualified": ["抢跑"], "waiver": ["弃权"] }
    }
  }
  ```
- `GET /competitions/:id`：返回赛事详情（含项目、组别、规则、报名配置、统计）。
- 所有写入接口使用事务，且 `authGuard` 校验是否为赛事创建者或管理员。

### 4.7 校验与异常处理
- 时间校验、非空校验、重复项目/组别提示、JSON 配置校验、权限校验（越权返回 403）。
- 保存失败保持表单数据，错误信息透传后端 `message`。
- 赛次或判罚引用冲突需警告并阻止提交。

### 4.8 后续迭代
- 草稿/发布状态、赛事复制、批量导入模板、赛程可视化、可视化规则编辑器及与导出模块联动。

## 5. 报名与队伍管理

### 5.1 报名流程
1. 队伍在“队伍花名册”维护成员、项目意向与赛次信息。
2. 提交 `POST /registrations`，后端校验报名时间窗口、项目/组别/赛次有效性、队伍归属。
3. 办赛方/管理员在“报名管理”页筛选报名，执行审批、备注、取消等操作。
4. React Query 自动失效缓存，刷新列表与统计；审批结果同步到队伍视图。

### 5.2 报名管理页面（RegistrationManager）
- 功能：赛事/状态筛选、分页、状态统计（待审/已过/已拒/已撤）、队伍详情展开、审批/备注/撤销、刷新。
- 支持接收外部 `externalCompetitionId` 以直达指定赛事报名列表。
- 计划支持批量审批、导出报名凭证、消息通知（TODO）。

### 5.3 队伍花名册（TeamMembersManager）
- 功能：行内编辑、批量粘贴（支持直接从 Excel 复制，自动识别逗号分隔，大小写与全角/半角逗号均可）、重复成员检测、历史记录对比、注册标记。
- 可切换赛事以查看赛次名单；保存时与报名表同步，自动创建或更新报名记录。
- 未来增加 CSV 模板下载、错误报告、操作日志与回滚。

### 5.4 接口
- `GET /registrations`：支持 `competitionId`、`status`、`page`、`pageSize`。
- `POST /registrations`：创建报名；异常场景（报名未开始/已结束、无效项目、越权）返回 400/403。
- `PATCH /registrations/:id`：更新状态、备注、附件、联系人信息。
- `DELETE /registrations/:id`：软删除为“已取消”。
- `GET /team/members` / `PUT /team/members`：队伍花名册读取/保存并同步报名。

## 6. 账号体系与管理员能力

### 6.1 角色与权限
- **admin**：系统管理员，可访问所有后台接口，包含账号/队伍/赛事/判罚/导出等操作。
- **organizer**：办赛方，可创建与管理自身赛事及报名数据。
- **team**：队伍账号，可维护花名册与报名信息。
- 未来如增加角色需补充权限矩阵与接口校验。

### 6.2 管理员页面
- 账号列表显示：账号（显示名/手机号/ID）、手机号、队伍名称（team 角色显示绑定队伍，其他角色显示 `-`）、角色、创建时间、操作。
- 角色支持内联切换；切换为 `team` 时需提示填写或关联队伍名称。
- **批量创建队伍**：
  - 支持模板上传或直接粘贴来自 Excel 的文本（逗号分隔，大小写与全角/半角均视为分隔符）。
  - 粘贴后展示解析预览，提示空列/格式错误并允许用户修正。
  - 调用 `POST /admin/teams/batch-create`，系统为每支队伍生成账号与随机密码并在结果中展示。
- **批量导出队伍**：
  - `GET /admin/teams/export` 导出队伍名称、账号、随机密码（可配置脱敏）、创建时间、联系人。
- **批量导入队伍**：
  - `POST /admin/teams/import` 支持携带成员列表；与快速批量创建区分场景。
- **其他能力**：密码重置、账号搜索、导出历史、操作日志面板（待完善）。

### 6.3 接口与示例
- `POST /admin/teams/import`：
  ```json
  {
    "teams": [
      {
        "name": "XX中学田径队",
        "contactPhone": "13800000000",
        "members": [
          { "name": "张三", "role": "领队", "age": 18 }
        ]
      }
    ]
  }
  ```
- `POST /admin/teams/batch-create`（拟定）：
  ```json
  {
    "teams": [
      { "name": "一队", "contactPhone": "13900000001" },
      { "name": "二队", "contactPhone": "13900000002" }
    ]
  }
  ```
  ```json
  {
    "teams": [
      {
        "name": "一队",
        "contactPhone": "13900000001",
        "account": {
          "userId": "uuid",
          "username": "13900000001",
          "password": "3gK8sX1p"
        }
      }
    ],
    "duplicatePhones": []
  }
  ```
- 粘贴解析要求：前端需在提交前将 Excel 数据转换为统一 JSON，自动将大小写、全角/半角逗号归一化，并提示缺失字段。
- `POST /admin/teams/reset-password`：返回新密码并提示运营人员通知队伍。

### 6.4 安全与审计
- 管理操作需记录日志并接入日志服务；敏感操作（导入、导出、批量创建、重置密码）需有操作人、时间、详情。
- 密码、验证码统一使用 bcrypt；敏感字段后续需支持加密/脱敏存储。
- 计划构建操作审计表与 RBAC 自动化测试，防止越权。

## 7. 登录、注册与认证

### 7.1 登录方式
- 手机号 + 验证码登录：`POST /auth/code` 发送验证码（有效期 5 分钟，非生产可使用测试码 `zxcasd`），`POST /auth/login/phone` 校验并签发 token。
- 微信授权（模拟）：`POST /auth/login/wechat` 使用临时代码生成 mock OpenID 并授予 organizer 角色。
- 登录成功展示 Toast（2~3 秒自动消失，可手动关闭）；Redux 存储用户与 token。

### 7.2 Token 管理
- axios 请求拦截器自动附带 Bearer Token；401 时调用 `POST /auth/refresh`，刷新失败自动登出。
- `POST /auth/logout` 与 `POST /auth/refresh` 对应刷新令牌的吊销与轮换。

### 7.3 登录页交互
- 采用 shadcn/ui 组件；验证码发送按钮带倒计时；表单错误在前端预校验并展示后端错误信息。
- 未登录用户在主界面显示引导提示；登录后展示用户姓名/手机号/角色，并提供登出。

## 8. 数据导出与判罚
- 当前支持队伍信息 JSON 导出；需继续实现赛事、报名、成绩、积分榜的 CSV/JSON 导出，并上传至腾讯云 COS 产生限时下载链接。
- 导出操作需提供历史记录、失败重试、权限校验与审计日志。
- 判罚结果与成绩处理流程需支持导出，以供仲裁与档案保留。

## 9. 非功能与指标要求
- 性能：关键路径（登录、加载赛事、加载报名）≤ 3 秒；大列表需支持懒加载或分页。
- 并发：后端连接池 `max = 10`，需支持 ≥500 并发的横向扩展方案。
- 日志与监控：接入 Sentry（前端）、腾讯云 CLS（后端）；部署流程记录于 `CHANGELOG_DEPLOY.md`。
- 安全：全链路 HTTPS；JWT 秘钥通过环境变量注入；敏感字段加密存储；日志保留 ≥30 天。
- 指标：注册人数、活跃登录数、赛事创建次数/成功率、报名人次、项目数量、审批耗时等需可统计。

## 10. 技术实现映射
- **前端组件**
  - 登录入口：`src/App.tsx`、`src/services/auth.ts`
  - 赛事向导：`src/components/CompetitionWizard.tsx`
  - 赛事详情：`src/components/competition/CompetitionDetailPanel.tsx`
  - 报名管理：`src/components/RegistrationManager.tsx`
  - 队伍花名册：`src/components/TeamMembersManager.tsx`
  - 管理员页面：`src/App.tsx` 中 `TabsContent value="admin"`
- **后端路由**
  - 认证：`backend/src/routes/auth.ts`
  - 赛事：`backend/src/routes/competitions.ts`
  - 报名：`backend/src/routes/registrations.ts`
  - 队伍：`backend/src/routes/team.ts`
  - 管理：`backend/src/routes/admin.ts`
- **数据库**：核心表在 `backend/src/database/client.ts`，含 users、competitions、competition_events、competition_groups、competition_rules、teams、competition_registrations、competition_registration_events、refresh_tokens、verification_codes。

## 11. 待办与风险
- 数据导出链路（生成 CSV/JSON、上传 COS、历史记录、失败重试）尚未完成。
- 判罚规则、成绩处理与赛程配置的 UI 与后端模型需进一步细化，确保与报名/成绩联动。
- 批量创建队伍、Excel 粘贴解析与错误提示需实现，并在 `TODO.md` 中跟踪。
- 监控与指标埋点仍缺（SLA、错误率、关键操作日志）。
- 安全方面需补充手机号/OpenID 加密、操作审计与 RBAC 自动化测试。

---
- 更新记录：合并原《需求文档.md》与《需求文件2.md》，2025-10-10。
- 维护人：研发团队；若有疑问请联系产品负责人并在变更后更新本文件及 `TODO.md`。
