# 产品需求文档

## 1. 产品愿景与定位
- 打造基于 **React + TypeScript** 的单页面应用，为办赛方提供赛事创建与配置能力，并兼顾参赛选手与简化版管理员的关键操作。
- 当前聚焦两大核心能力：用户注册/登录（含报名基础支持）与赛事创建配置（覆盖项目设置与流程管理）。
- 核心成功指标：
  - 用户注册完成率 ≥ 90%。
  - 赛事创建成功率 ≥ 95%。
- 实现遵循《AGENTS 协作指南》，确保需求、设计、实现保持一致。

## 2. 用户角色与旅程
- **办赛方**：注册登录 → 浏览赛事列表 → 创建/编辑赛事 → 配置项目与流程 → 发布赛事 → 导出数据。
- **参赛选手**：注册登录 → 浏览赛事 → 填写报名信息 → 跟踪赛程与成绩。
- **管理员（简化版）**：登录 → 审核账号（可选） → 导出赛事及报名数据。

## 3. 核心业务场景与约束
- 登录方式覆盖手机号 + 验证码与微信授权，使用 JWT 维持会话并支持刷新。
- 赛事配置需支持项目模板选择、分组/人群设定、报名限制、赛程流程、积分规则、成绩与异常处理。
- 支持赛事及报名数据的 JSON/CSV 导出，导出内容与数据库保持一致。
- 系统需预留并发 ≥ 500 的扩展空间；关键交互 3 秒内响应，可结合懒加载与骨架屏优化。
- 敏感数据加密存储，全链路 HTTPS，保留操作日志不少于 30 天。

## 4. 功能需求拆分
### 4.1 注册与登录模块
- 支持手机号 + 验证码登录流程：发送、校验、重试、滑块/图形验证码防刷策略。
- 支持微信授权登录与 OpenID 绑定，与手机号账号可互相绑定或合并。
- JWT 鉴权：提供令牌签发、续期、刷新策略，记录续期条件与失败处理。
- 登录成功提示：前端在成功登录后展示 Toast/Alert，2-3 秒后自动渐隐，同时保持可关闭交互。
- 登录与注册流程埋点记录注册量、登录活跃数及失败原因。

### 4.2 赛事配置向导模块
- 首页显示赛事列表，支持分页/搜索。列表项可点击进入赛事详情页，详情页允许修改赛事基础信息、项目配置、积分与报名规则等。
- 列表顶部提供 `新增比赛` 按钮，打开赛事配置向导（多步骤表单）。
- 向导步骤建议：
  1. 基础信息（名称、时间、地点、封面、赛事标签）。
  2. 项目模板与分组配置（选择标准模板、自定义项目、组别、报名限制）。
  3. 赛程流程与积分策略（预赛/决赛、晋级条件、默认积分表、项目覆写）。
  4. 成绩录入与预览设置（录入方式、异常处理策略、预览界面勾选项）。
  5. 汇总确认（校验数据、一键发布）。
- 向导需支持草稿保存、跨步骤校验、回退与继续编辑。
- 办赛方可在详情页切换不同模块视图，确保配置可追踪并支持对比变更记录。

### 4.3 项目模板与报名规则模块
- 默认提供田径标准项目（100m、200m、400m、4×100m、跳远、铅球等），按径赛/田赛分类，支持个人与团体赛制。
- 支持赛事级和模板级的增删改：可从标准模板复制调整，并保存为自定义模板复用。
- 报名规则配置：
  - 组别维度：性别（男子/女子/混合）、年龄段（少年/青年/成年）、身份（运动员/学生/教师）。
  - 报名限制：个人参赛项目上限、团体项目固定人数、报名审核流程、候补名单。
  - 团队信息：队名、领队、联系方式等必填字段。
- 报名接口需返回配置校验结果，错误信息可直接展示给前端表单。

### 4.4 积分规则模型模块
- 默认积分表：名次 1-8 分别对应 9/7/6/5/4/3/2/1 分，允许赛事级调整。
- 项目覆写：每个项目可独立设置积分规则（名次-积分映射、自定义名次上限、平局分配策略）。
- 支持多赛制积分：针对个人赛与团体赛分别设定计算方式（个人累积分、团队按成员总分/平均分）。
- 加分与扣分策略：允许为纪录突破、裁判判罚等配置额外加扣分项，并记录触发条件。
- 数据模型要求：
  - 后端定义积分规则实体，关联赛事、项目、组别。
  - 版本化管理，历史积分方案可追溯。
  - 前端表单提供实时预览，展示不同名次对应的积分结果。
- 验收标准：可完成至少一个赛事的积分方案配置，保存后前端回显准确，并在成绩录入模块正确引用。

### 4.5 成绩录入与异常处理模块
- 录入方式：
  - 手动录入：支持批量输入成绩、单位转换（秒/分、米/厘米）。
  - 导入录入：Excel/CSV 模板导入，自动校验格式与缺失项。
- 成绩校验：配置晋级规则、最好成绩/累计成绩判定，录入时自动提示晋级/淘汰。
- 异常处理：提供弃权、犯规、取消成绩、重赛等状态选项，支持附加备注和证据上传。
- 复核流程：录入后需双人复核或系统自动复核，记录操作日志，可回滚到上一版本。
- 数据联动：成绩变化实时刷新积分、排名与预览界面，同时触发通知（站内或短信）。
- 验收标准：
  - 能录入至少两个项目的成绩并正确计算晋级与积分。
  - 异常状态在列表与导出文件中准确体现。

### 4.6 前端预览界面模块
- 预览入口：赛事配置向导与赛事详情页均提供“预览赛事”按钮，打开只读页面。
- 展示内容：赛事基础信息、项目/组别安排、积分方案摘要、赛程流程、报名限制提示。
- 结果展示：集成成绩列表、实时积分榜、异常标识（例如灰显弃权、标注犯规）。
- 交互规范：基于 shadcn/ui 组件与 Tailwind CSS，实现响应式布局、骨架屏、分页与筛选。
- 性能要求：首屏渲染 < 1.5 秒，分页/筛选响应 < 800ms，必要时使用虚拟列表。
- 权限控制：未登录用户仅能预览公开信息；办赛方登录后可直接跳转到可编辑视图。
- 验收标准：
  - 可通过预览界面验证配置是否正确，无需先发布。
  - 预览界面数据与实际配置保持一致，刷新后状态不丢失。

### 4.7 报名管理模块
- 参赛队伍可按赛事选择项目并填写所需信息，上传证明材料由系统校验格式。
- 办赛方侧报名列表支持状态筛选、批量导出、审批通过/驳回及补充材料提醒。
- 队伍（team 角色）端报名管理页移除审批操作，仅展示已报名赛事的基础信息（报名状态、提交时间、参赛成员等）。
- 队伍端新增“队员管理”页面：点击“添加队员”按钮弹出输入面板，每一行代表一名队员，字段顺序为姓名、性别、组别、项目一、成绩一、项目二、成绩二、项目三、成绩三、项目四、成绩四、项目五、成绩五。
- 队员管理页面底部展示汇总表格，列出全部队员的报名详情（所报项目与成绩、所属组别等，支持下拉修改），并预留后续编辑、删除等操作入口。
- 队伍端赛事管理页去除“设置”“向导”模块，仅保留赛事基础信息与操作入口；操作列提供“详情”（跳转到报名管理并默认筛选当前赛事）与“快速报名”（弹出队员管理）按钮，支持高亮切换当前报名赛事。
- 队员管理弹窗在保存时必须携带赛事信息，后端将队员名单写入该赛事对应的报名记录与项目列表，实现“保存即报名”效果。
- 队伍端报名无需审批，保存成功后立即计入赛事报名人数，并在报名管理中可见对应队伍与队员。
- 报名管理支持按赛事下拉筛选，并以队伍为单位展示报名详情（队伍信息及队员列表）。
- 后台提供报名状态、队伍成员信息的通知推送能力。
- 报名数据需遵循配置的上限，若超额需实时提示并禁止提交。

### 4.8 数据导出模块
- 支持赛事详情、报名信息、成绩结果、积分榜导出为 CSV/JSON。
- 导出链路：数据库查询 → 生成文件 → 上传 COS → 返回带有效期的下载地址。
- 导出任务需异步处理，前端展示进度、失败重试、历史记录。
- 导出文件格式须与数据库字段对齐，敏感信息按权限脱敏。

### 4.9 管理与权限模块
- 提供简化管理员账号管理：创建、禁用、角色分配。
- 默认手机号 15521396332 的账号拥有系统管理员权限，可管理赛事与用户。
- 审计日志记录关键操作：登录、配置变更、成绩修改、导出。

## 5. 数据指标与监控
- 指标覆盖：注册人数、活跃登录数、赛事创建次数与成功率、各赛事报名人次、项目数量、导出次数。
- 前端埋点记录关键页面加载、操作成功/失败；后端结合日志服务统计 API 成功率、延迟、错误率。
- 建议建设运营看板，实时展示 SLA 与异常告警，并提供周报输出。

## 6. 技术方案概览
### 6.1 前端架构
- 技术栈：React + TypeScript + Vite，使用 pnpm 管理依赖。
- 状态管理：Redux Toolkit 存储用户态与赛事配置，React Query 管理接口缓存与请求重试。
- UI：Tailwind CSS + shadcn/ui，自建表单、表格、选择器等组件，保证可定制主题与暗黑模式。
- 网络层：Axios 二次封装，统一鉴权、错误提示、超时与重试策略。

### 6.2 后端服务
- Node.js + Express（TypeScript）部署于腾讯云 CloudBase Run。
- 数据库：PostgreSQL，存储用户、赛事、项目、报名、成绩、积分规则、操作日志等表。
- 文件存储：腾讯云 COS，生成临时下载链接供导出与附件访问。
- 鉴权：手机号验证码、微信 OpenID 绑定，JWT 作为会话令牌，支持刷新与注销。

### 6.3 数据流转
- 注册登录 → API → 用户表 → 签发 JWT → 返回前端存储与续期。
- 赛事配置 → API → 赛事/项目/积分/报名规则表 → 预览/详情实时读取。
- 成绩录入 → API → 成绩表/积分表 → 推送通知与预览更新。
- 数据导出 → 查询 → 生成 CSV/JSON → 上传 COS → 提供下载地址与日志。

### 6.4 DevOps 与运维
- 持续集成：GitHub Actions 覆盖构建、测试、部署流水线。
- 部署脚本遵循《需求文档.md》“一键部署”规范：基于 Node.js/TypeScript 或兼容 shell，依赖 Node.js 18+、pnpm 8+、CloudBase CLI；命令示例 `pnpm deploy:cloudbase`。
- 失败自动回滚：部署失败时回滚到上一稳定版本，并更新变更日志。
- 监控告警：前端集成 Sentry，后端接入腾讯云日志服务与告警。
- 日志与配置：操作日志保留 ≥ 30 天，敏感字段加密，供审计追踪。

## 7. 安全与合规
- 全链路 HTTPS，使用 TLS 1.2 及以上。
- 手机号、OpenID 等敏感字段加密存储，并限制访问权限。
- 登录、配置、成绩等操作需记录审计日志，支持检索与导出。
- 权限模型需与角色配置联动，避免水平越权。

## 8. 验收标准
- 可完成一个赛事及多个项目的配置，包含积分规则、成绩录入、预览界面联动，数据保存准确。
- 登录与报名流程稳定，验证码错误可重试，登录成功提示渐隐。
- 成绩录入与异常处理流程可完整回放，并在预览界面及导出文件中正确呈现。
- 数据导出文件与数据库保持一致，导出日志可追踪。

## 9. 变更与协作要求
- 新增或更新功能需先与 PM/RD 对齐需求，并同步更新本需求文档与 TODO 列表。
- 开发需记录影响范围、接口变更、数据迁移方案，提交代码前通过本地测试。
- PR 需描述功能点、验证方式、影响指标；部署脚本与自动化管道优先保障可用。
- 若实现与本指南冲突，先更新需求文档并通知相关角色，确保信息一致。

