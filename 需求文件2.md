# 需求文件2：核心功能详案

## 0. 文档说明
- 本文基于现有实现（前端 `frontend/`、后端 `backend/`）以及《需求文档.md》，聚焦补充“比赛创建管理”“账号创建管理”“登录/注册/报名”三大能力的细化需求。
- 内容涵盖用户场景、功能清单、页面结构、接口字段、异常处理及后续迭代建议，默认使用 UTF-8 编码。
- 本文不重复描述通用非功能指标（如 KPI、监控、安全），仅在相关章节补充与本能力直接相关的要求。

## 1. 范围与目标
- 范围：赛事主办方（organizer）、参赛队伍（team 角色）、管理员（admin 角色）在 Web SPA 中完成登录、创建赛事、维护报名、运维账号的完整闭环。
- 目标：
  - 办赛方可以在 5 分钟内创建并配置一场赛事，准确管理项目、组别、规则及报名设置。
  - 管理员可以快速导入/导出队伍账号、调整角色、重置密码，保障账号体系安全可控。
  - 参赛端可顺畅完成登录、报名、花名册维护；办赛方可以实时查看并审批报名信息。

## 2. 比赛创建与管理

### 2.1 用户场景
- 办赛方通过登录进入“赛事管理”页，查看自己创建的赛事列表，掌控报名进展。
- 办赛方点击“创建赛事”打开向导，逐步完善赛事信息；亦可在详情面板中按标签页继续编辑。
- 管理员需能够查看全量赛事，并在特殊情况下协助编辑或排查。

### 2.2 核心流程
1. 办赛方进入“赛事管理”Tab。
2. 点击“创建赛事” → `CompetitionWizard` 向导弹层开启。
3. 向导依次收集：基本信息 → 项目配置 → 组别配置 → 规则设置 → 确认提交。
4. 提交成功后，向导展示成功提示并刷新赛事列表；失败时显示错误信息并保留表单数据。
5. 进入赛事详情时，`CompetitionDetailPanel` 读取 `GET /competitions/:id`，以标签页形式允许继续编辑；保存后刷新 Query 缓存与列表。

### 2.3 页面组成
- **赛事列表**
  - 展示字段：名称、报名时间、比赛时间、地点、报名人数、队伍数、操作（进入详情、编辑、打开向导）。
  - 支持刷新按钮、分页（若后续返回数据较多）。
- **创建/编辑向导（模态）**
  - 步骤条：基本信息、项目配置、组别配置、规则设置、确认提交。
  - 表单校验：赛事名称、报名开始/结束时间必填；下一步按钮在校验通过后才可用。
  - 项目配置扩展：
    - 项目类型分为【田径标准类】【全能类】【趣味类】【评分类】四大类；选择“田径标准类”时，会自动带出标准田径项目及其默认设置。
    - 对于竞赛类项目，支持选择赛道模式：`分道跑` / `不分道跑`，以决定后续的赛道分配与成绩录入方式。
    - 每个项目需指定计分类型：`计时类`（秒）、`远度类`（米）、`高度类`（米），用于成绩录入与排序。
    - 支持为单个项目新增赛次（详见 2.5），包括日期、开始时间、场地与赛次编号。
  - 默认值：向导初始化时调用 `GET /competitions/templates/events` 填充标准田径项目（含默认项目类型、赛道模式、计分类型及默认赛次）；默认组别（男子/女子学生组）；默认规则（积分表、晋级方式、异常列表）。
  - 确认页展示结构化预览；提交中按钮显示 Loading。
- **赛事详情面板**
  - 标签页：基础信息、项目、组别、规则、报名配置（JSON 编辑区）。
  - 提供 JSON 格式校验与错误提示；追踪草稿与原始数据差异；保存后 toast 提示成功。
  - 展示摘要：报名人数、队伍数、创建人、创建时间。

### 2.4 数据与接口
- 关键接口：
  - `GET /competitions/templates/events`：返回标准事件列表（字段：name、category、unitType）。
  - `GET /competitions`：返回当前用户可见赛事列表，附带统计数据。
  - `POST /competitions`：创建赛事，接受字段：
    - `name` (string) 必填
    - `location` (string)
    - `signupStartAt` / `signupEndAt` (string, ISO)
    - `startAt` / `endAt` (string, ISO)
    - `config` (object) 保存扩展配置（含报名限制）
    - `events` (array) 每项包含：
      - `name`
      - `category`：保留原 track/field，同时扩展 `all_round`（全能类）、`fun`（趣味类）、`score`（评分类）；该字段用于前端分组展示及统计。
      - `competitionMode`：针对竞赛类项目新增，取值 `lane`（分道跑）、`mass`（不分道跑）；对于非竞赛类项目可为空。
      - `scoringType`：`timing`（计时类）、`distance`（远度类）、`height`（高度类），决定成绩录入单位与排名规则。
      - `unitType` (`individual`/`team`)
      - `sessions`：赛次数组，每个赛次包含 `date`、`startTime`、`venue`、`sessionCode`（赛次编号），至少一个条目。
      - `isCustom`
      - `config`：保留扩展字段，用于存储自定义赛道配置、器材要求等。
    - `groups` (array) 包含 `name`、`gender`、`ageBracket`、`identityType`、`maxParticipants`、`teamSize`、`config`
    - `rules` (object) 包含 `scoring`、`flow`、`penalties`
  - `GET /competitions/:id`：返回赛事详情，包含统计、项目、组别、规则、配置。
  - `PATCH /competitions/:id`：全量更新比赛，后端会在事务中重建项目/组别并更新规则。
- 权限：办赛方仅能编辑自己创建的赛事；管理员拥有全量权限；越权返回 403。
- 数据约束：后端通过 zod 校验数据格式；数据库表结构详见 `backend/src/database/client.ts`。

### 2.5 项目、赛次与计分设置（新增）
- **项目类型扩展**
  - 标准田径项目继续作为默认模板，支持一键导入；模板内预设项目类型（田径标准类）、赛道模式、计分类型、默认赛次与判罚规则。
  - 新增“全能类”项目，可配置多个子项并以分项成绩计算综合积分；需预留接入国际全能换算表的接口（TODO）。
  - 新增“趣味类”“评分类”项目，允许自定义评分维度与展示方式，默认不启用赛道模式。
- **赛次管理**
  - 每个项目支持添加多个赛次，字段包含：赛次编号、日期、开始时间、预计结束时间、场地/道次范围、赛次备注。
  - 支持批量生成赛次（按日期时间段复制）、赛次排序、赛次启用/停用。
  - 报名阶段需根据赛次开放情况展示可选赛次，并校验报名人数上限。
- **计分规则**
  - 计分类型（计时类、远度类、高度类）与成绩录入单位绑定；系统需在成绩处理页根据计分类型给出默认排序与取值精度。
  - 每个项目可覆盖默认积分表（含 9/7/6/5/4/3/2/1）或自定义积分配置；全能类需支持子项权重或换算系数。
  - 晋级逻辑（按最好成绩或累计成绩）在项目级配置，赛次晋级名单自动生成。
- **赛道模式**
  - `分道跑` 项目需维护道次配置（赛道数量、起跑规则、道次锁定），并允许导出赛道编排。
  - `不分道跑` 项目需支持按组编排和滚动起跑提醒，成绩录入以小组排序展示。
- **判罚与结果联动**
  - 项目配置需关联判罚规则集（详见 2.7），确保成绩处理页可调用相应的判罚项。
  - 赛次完成后，成绩处理页可对指定选手添加判罚，并自动更新积分/晋级状态。

### 2.6 校验与异常
- 报名时间：`signupStartAt < signupEndAt`，`startAt <= endAt`；向导中需校验并提示。
- 项目/组别命名：前端需保证非空且去除首尾空格；后端已做基本校验。
- 重复项目：向导可提示重复名称（TODO），当前依赖用户手动检查。
- 保存失败：展示后端返回的 message，保留现有输入。
- JSON 配置：`CompetitionDetailPanel` 在切换或保存前校验 JSON，失败时阻止提交并展示错误详情。

### 2.7 后续迭代（建议）
- 赛事草稿/发布状态管理、列表筛选、复制赛事。
- 规则配置的可视化编辑器、报名限制的结构化表单。
- 与导出模块打通：按赛事导出报名、成绩、积分表。

### 2.8 判罚规则与成绩处理
- **判罚规则管理页面**
  - 在赛事管理中新增“判罚规则”独立页面，支持按赛事或项目维护判罚项。
  - 支持批量导入 / 新增判罚编号 + 判罚内容（含扣分/成绩判定方式），可快速生成常见判罚模板。
  - 判罚规则可关联到多个项目；项目在更新时需选择对应的判罚集。
  - 提供搜索、启用/停用、备注、导出功能，便于裁判与编排人员使用。
- **成绩处理页集成**
  - 成绩处理页面需展示对应项目的判罚项，支持对选手成绩进行判罚（扣分、取消成绩、补录备注）。
  - 判罚操作需记录操作人、时间、判罚编号，并同步更新积分/晋级状态。
  - 需提供撤销与操作日志，以防止误判；判罚结果应可导出供仲裁存档。

## 3. 账号创建与管理

### 3.1 角色与权限
- **admin**：系统管理员，可访问全部后台接口，进行账号、队伍、赛事的跨域操作。
- **organizer**：办赛方，默认可创建赛事、管理报名、查看自己创建的赛事。
- **team**：参赛队伍账号，默认仅能访问队伍花名册与关联报名。
- 所有接口通过 JWT 认证，`authGuard` 注入 `req.user` 并根据角色控制访问。

### 3.2 管理员操作能力
- 账号列表：`GET /admin/accounts`，可查看所有用户的 ID、手机号、显示名、角色、创建时间。
- 角色调整：`PATCH /admin/accounts/:userId/role`，在前端下拉框中切换角色；提交后刷新列表。
- 队伍导入：`POST /admin/teams/import`，批量导入队伍信息（名称、联系人、成员列表），后台自动创建用户并生成随机密码。
- 批量创建队伍：新增 `POST /admin/teams/batch-create`（拟定），支持仅提供队伍名称 + 联系方式即可创建账号，返回生成的账号/密码；与导入接口形成差异化（导入偏向携带成员数据，批量创建偏向快速开户）。
- 队伍导出：`GET /admin/teams/export`，返回所有队伍及账号信息。
- 密码重置：`POST /admin/teams/reset-password`，为队伍账号生成新密码。
- 批量创建与导入前端在提交前需支持解析 Excel 复制粘贴的文本内容（逗号分隔，不区分大小写/中英文字符），并对空列或格式错误进行提示。

### 3.3 页面与交互
- **管理员 Tab（App.tsx 中的 `TabsContent value="admin"`）**
  - 顶部提示当前账号数量，提供刷新按钮。
  - 列表展示账号信息，新增“队伍名称”列（当角色为 team 时显示绑定队伍名，其他角色显示 `-`），并保留手机号、角色、创建时间等字段。
  - 角色列支持内联下拉切换（调用 `updateAccountRole`），当角色切换为 `team` 时需提示填写队伍名称。
  - 新增“批量创建队伍”入口，支持上传模板或在弹窗中批量录入队伍名称、联系人、手机号，系统自动生成随机密码并在结果列表中展示。
  - 批量录入需兼容直接从 Excel 复制的文本内容：自动识别以逗号分隔的字段（大小写、全角/半角逗号均视为分隔符），并在提交前展示解析预览，提示异常单元格。
  - 新增“批量导出队伍账号”入口，导出内容含队伍名称、账号、随机密码（可选掩码）、创建时间，便于线下通知。
  - 未来需要增加：导入按钮支持 JSON/CSV、密码重置按钮 UI、操作历史记录面板；已在 TODO 中排期。
- **系统默认管理员**
  - 手机号 `15521396332` 在首次登录时自动升级为 admin，便于初始化运营。

### 3.4 数据与接口
- 导入接口 payload：
  ```json
  {
    "teams": [
      {
        "name": "xx中学田径队",
        "contactPhone": "13800000000",
        "members": [
          { "name": "张三", "role": "领队", "age": 18 }
        ]
      }
    ]
  }
  ```
  - 密码使用 bcrypt 加密存储；导入结果返回 teamId、userId、生成的账号/密码。
- 导出接口返回：
  ```json
  {
    "teams": [
      {
        "teamId": "...",
        "name": "...",
        "contactPhone": "...",
        "members": [...],
        "account": {
          "userId": "...",
          "displayName": "...",
          "phone": "..."
        }
      }
    ]
  }
  ```
- 批量创建接口 `POST /admin/teams/batch-create` 建议请求/响应格式：
  ```json
  {
    "teams": [
      { "name": "一队", "contactPhone": "13900000001" },
      { "name": "二队", "contactPhone": "13900000002" }
    ]
  }
  ```
  ```json
  {
    "teams": [
      {
        "name": "一队",
        "contactPhone": "13900000001",
        "account": {
          "userId": "...",
          "username": "13900000001",
          "password": "3gK8sX1p"
        }
      }
    ],
    "duplicatePhones": []
  }
  ```
- 粘贴解析要求：支持 Excel 单元格粘贴，默认按逗号分列；对大小写差异、全角逗号自动规整为半角，保证后端接收到结构化 JSON。
- 密码重置接口返回新密码，需前端弹窗提示并引导运营人员通知队伍。

### 3.5 安全与审计
- 所有管理员操作需记录日志（后端已输出 console，后续需接入日志服务）。
- 密码、验证码使用 bcrypt，防止明文泄露。
- 未来需补充：
  - 操作审计表（记录谁在何时导入、导出、重置密码）。
  - 导入文件校验（格式、必填、重复手机号）。
  - RBAC 自动化测试，防止越权修改其他 admin。

## 4. 登录、注册与报名

### 4.1 登录/注册流程
1. 用户访问系统，`App.tsx` 检测无登录态后展示登录卡片。
2. 选择“手机号登录”：
   - 输入手机号 → 发送验证码（`POST /auth/code`），倒计时 60 秒并禁用重复发送。
   - 输入验证码 → 提交 `POST /auth/login/phone`。
   - 登录成功展示 Toast，2~3 秒后自动隐藏；Redux 存储 token 与用户信息。
3. 选择“微信授权”：输入临时代码 → `POST /auth/login/wechat` → 成功后授予 organizer 角色。
4. axios 拦截器为所有请求带上 Bearer Token；若 401 自动使用 `POST /auth/refresh` 刷新，失败则登出。

### 4.2 登录页与状态反馈
- 组件：`Card` + `Tabs`（手机号 / 微信），输入框来自 shadcn/ui。
- 交互：
  - 验证码发送按钮显示倒计时； loading 状态禁用按钮。
  - 表单错误：手机号格式不正确、验证码长度不足，在前端校验；后端错误传回 message 并显示在 Toast 区域。
  - 支持手动关闭 Toast（`X` 图标按钮）。
- 未登录状态提示文案：“请先登录后操作”；登录后展示用户姓名/手机号与角色。

### 4.3 报名功能流程
1. 办赛方或管理员进入“报名管理”Tab (`RegistrationManager`)。
2. 默认展示全部报名，提供状态（全部/待审/已通过/已拒绝/已取消）和赛事筛选，下方为统计摘要。
3. 列表项展示报名人、所属队伍、选择的项目、提交时间、状态；可进入详情（在当前组件内展开卡片）进行审批、备注、撤销。
4. 参赛队伍通过“队伍花名册”（`TeamMembersManager`）维护成员、分组、项目；保存时若选择了赛事，将自动同步报名记录。
5. 审批动作：
   - `updateRegistration`：更新状态、备注、附件、联系信息。
   - `cancelRegistration`：将状态标记为已取消。
   - 变更后 `React Query` 自动失效缓存，刷新列表与统计。

### 4.4 报名页面与组件
- **RegistrationManager**
  - 顶部：筛选条件、统计面板（待审/已过/已拒/已撤）。
  - 列表：分页（`page` 状态），每行含项目列表；点击可展开队伍详情。
  - 详情弹窗：支持审批按钮、备注编辑、取消报名、重新加载按钮。
  - 支持对接外部联动：当外部组件传入 `externalCompetitionId` 时自动应用筛选。
- **TeamMembersManager**
  - 支持页面模式与模态模式；当前在队伍 Tab 中以页面形式出现。
  - 功能：行内编辑、批量粘贴（支持直接从 Excel 复制，自动识别逗号分隔且不区分大小写/全角半角）、历史记录对比、重复成员检测、事件列表上限 5 个。
  - 在保存成功后刷新 `RegistrationManager`，保证报名状态同步。

### 4.5 后端接口概览
- `POST /registrations`：提交报名，校验报名时间窗口、项目/组别有效性、队伍归属；插入报名记录及关联项目。
- `GET /registrations`：支持 `competitionId`、`status`、`page`、`pageSize` 查询。
- `PATCH /registrations/:id`：更新状态、备注、附件、联系方式。
- `DELETE /registrations/:id`：软删除为已取消。
- `GET /team/members` / `PUT /team/members`：队伍花名册读取/保存，并在保存时同步报名。
- 错误处理：
  - 报名时间未到/已过返回 400。
  - 越权操作返回 403。
  - 重复报名、无效项目或分组返回 400。

### 4.6 安全与体验要求
- 验证码尝试失败超过阈值需在后续版本加入限制；当前仅提供基本提示。
- 令牌刷新：刷新失败立即登出，避免使用无效凭证。
- 报名审批操作需记录操作人（后端可在日志中输出 `req.user.id`，后续需落地审计表）。
- 队伍花名册的历史记录保存在内存中，后续需将变更写入数据库（TODO）。

## 5. 非功能补充
- **性能**：关键操作（登录、打开赛事列表、加载报名列表）需在 3 秒内响应；大列表场景建议引入懒加载。
- **并发**：后端连接池 `max=10`，支持 ≥500 并发的扩展需求需结合 CloudBase 水平扩展方案。
- **日志**：部署脚本已输出部署信息，业务操作日志需接入腾讯云 CLS；前端计划接入 Sentry。
- **安全**：全链路 HTTPS、JWT 秘钥通过环境变量注入、验证码和密码使用 bcrypt；敏感字段后续需加密存储。

## 6. 与代码实现的映射
- 前端组件：
  - 赛事创建：`src/components/CompetitionWizard.tsx`、`src/components/competition/CompetitionDetailPanel.tsx`
  - 报名管理：`src/components/RegistrationManager.tsx`
  - 队伍花名册：`src/components/TeamMembersManager.tsx`
  - 登录入口：`src/App.tsx`（未登录视图）、`src/services/auth.ts`
  - 管理员页面：`src/App.tsx` 内 `TabsContent value="admin"`
- 后端路由：
  - 认证：`backend/src/routes/auth.ts`
  - 赛事：`backend/src/routes/competitions.ts`
  - 报名：`backend/src/routes/registrations.ts`
  - 队伍：`backend/src/routes/team.ts`
  - 管理：`backend/src/routes/admin.ts`
- 数据库结构：`backend/src/database/client.ts`（包含 users、competitions、events、groups、rules、teams、registrations 等定义）。

---
- 文档维护人：研发团队
- 更新时间：以最后提交为准，更新时请同步《需求文档.md》与 `TODO.md`
